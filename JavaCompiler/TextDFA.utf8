Â·Â·Â·
Deterministic Finite Acceptor of Text Literals with Interpolation
Multiple physical lines are preserved with amended indentation.
Â·Â·Â·
import java.util.LinkedList

â–  TextDFAâ¦‚ DFA

  openingDelimiterâ¦‚ String
  closingDelimiterâ¦‚ String
  stateâ¦‚  Lex Â· DFA state as a Token name
  tokensâ¦‚ LinkedListâŸ¨TokenâŸ©Â° Â· output
  linesâ¦‚  LinkedListâŸ¨LinkedListâŸ¨TokenâŸ©âŸ©Â° Â· completed text lines
  lineâ¦‚   StringDFAÂ° Â· next line
  valueâ¦‚  StringBuilderÂ° Â· seeking for closing delimiter

  â–¶ reset
  âº startâ¦‚ String
    tokens.clearÂ°
    lines.clearÂ°
    if âˆ„ start
    or Â¬ The.closingDelimiters.containsKey start
    or Â¬ The.delimitedSequences.containsKey start
    or Â¬ "Text" â‰ˆ The.delimitedSequences.get start
       openingDelimiter: ""
       state: Lex.ERR Â· does not accept any input
    else
       openingDelimiter: start
       closingDelimiter: The.closingDelimiters.get start
       line.reset null Â· thus stop symbol of StringDFA is '\n'
       value.setLength 0
       state: null Â· first line status until the first linebreak

  â–¶ consumeâ¦‚ boolean
  âº câ¦‚ Character
    if âˆ„ state Â· first line before the first linebreak
       value.append c
       if c = '\n'
          value.setLength 0
          state: Lex.TXT

       if c.isWhitespace c then return true
       else
          tokens.add *Token Lex.ERR,
                     "INVALID START OF TEXT > " âŠ• openingDelimiter
          state: Lex.TXT
          return consume c

    if state = Lex.ERR then return false

    value.append c
    if closingDelimiter.startsWith value.toStringÂ°
       if  closingDelimiter.equals value.toStringÂ°
       and line.state â‰  StringDFA.State.IP Â· end of text
           line.consume '\n' Â· send stop symbol to StringDFA
           tokens.addAll line.getTokensÂ°
           âƒ«Specify indentation in value:
           value.setLength 0
           value.append tokens.removeLastÂ°.value
           value.setLength value.lengthÂ° - closingDelimiter.lengthÂ° + 1
           if Â¬ tokens.isEmptyÂ°
           or Â¬ value.toStringÂ°.trimÂ°.isEmptyÂ°
              tokens.add *Token Lex.ERR, value.toStringÂ° âŠ•
                         closingDelimiter âŠ• " < INVALID END OF TEXT"
              lines.add tokens
              tokens: *LinkedListâŸ¨âŸ©Â° Â· clear would destroy the last line
              value.setLength 0 Â· no indentation when error
           âƒ«Build string with properly indented lines:
           âˆ€ textline âˆˆ linesâ¦‚ LinkedListâŸ¨TokenâŸ©
             firstTokenâ¦‚ Token: textline.removeFirstÂ°
             if firstToken.name = Lex.ERR Â· invalid start of text
                tokens.add firstToken
             else
                tokens.add *Token Lex.STR,
                  (firstToken.value.lengthÂ° < value.lengthÂ° ? "" !
                   firstToken.value.substring value.lengthÂ°)
             tokens.addAll textline
             tokens.add *Token Lex.STR, System.lineSeparatorÂ°
                   .(replaceAll "\r", "\\\\r").replaceAll "\n", "\\\\n"

           state: Lex.ERR
           return true

    else Â· initialize new prefix of closing delimiter
      ğŸ”ï¹– 0 < value.lengthÂ° and
          Â¬ closingDelimiter.startsWith value.toStringÂ°
            value.deleteCharAt 0

    if c = '\n'
    and line.state â‰  StringDFA.State.ES
    and line.state â‰  StringDFA.State.IP Â· end of line
        lineResultâ¦‚ boolean: line.consume c
        tokens.addAll line.getTokensÂ°
        lines.add tokens
        tokens: *LinkedListâŸ¨âŸ©Â° Â· clear would destroy the last line
        line.reset null
        return lineResult

    unless line.consume c Â· error ?
        tokens.addAll line.getTokensÂ°
        lines.add tokens
        tokens: *LinkedListâŸ¨âŸ©Â° Â· clear would destroy the last line
        line.reset null
        return line.consume c

    return true

  â–¶ getTokensâ¦‚ LinkedListâŸ¨TokenâŸ©
    if state â‰  Lex.ERR Â· ERR is the stop and accept (!) state of the DFA
       tokens.clearÂ°
       âˆ€ textline âˆˆ linesâ¦‚ LinkedListâŸ¨TokenâŸ©
         tokens.addAll textline
       tokens.add *Token Lex.ERR, " < INVALID TEXT LITERAL"
    return tokens
